
stages:
  - build
  - test
  - scan
  - containerize
  - deploy_staging
  - approval
  - deploy_production

default:
  image: alpine:3.19
  before_script:
    - apk add --no-cache bash docker-cli curl jq

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: ""

workflow:
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "develop"'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'

.deploy_rules: &deploy_rules
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: on_success
      allow_failure: false
    - when: never

build:
  stage: build
  script:
    - echo "Compile and package the application here"
  artifacts:
    paths:
      - build/
  rules:
    - when: on_success

test:
  stage: test
  script:
    - echo "Run unit and integration tests"
  needs: ["build"]
  rules:
    - when: on_success


scan:
  stage: scan
  image: aquasec/trivy:latest
  script:
    - trivy --version
    # File-system (SAST-like) scan for HIGH/CRITICAL
    - trivy fs --exit-code 1 --severity HIGH,CRITICAL --ignore-unfixed .
    # Optional image scan if a previous containerize stage already built an image tag variable
    - if [ -n "${CI_REGISTRY_IMAGE:-}" ]; then echo "Scanning latest image"; trivy image --exit-code 1 --severity HIGH,CRITICAL "${CI_REGISTRY_IMAGE}:$CI_COMMIT_SHORT_SHA" || true; fi
  needs: ["test"]
  artifacts:
    when: always
    reports:
      dotenv: trivy.env
    paths:
      - trivy-report.json
  rules:
    - when: on_success
containerize:
  stage: containerize
  image: docker:27.0
  services:
    - docker:27.0-dind
  script:
    - echo "Build image"
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" "$CI_REGISTRY"
    - docker build -t "$CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA" .
    - docker push "$CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA"
    - docker tag "$CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA" "$CI_REGISTRY_IMAGE:latest"
    - docker push "$CI_REGISTRY_IMAGE:latest"
  needs: ["scan"]
  rules:
    - when: on_success

deploy_staging:
  stage: deploy_staging
  script:
    - echo "Deploy to staging (kubectl apply ... or ECS CLI)"
  environment:
    name: staging
    url: https://staging.example.com
  needs: ["containerize"]
  rules:
    - if: '$CI_COMMIT_BRANCH == "develop"'
      when: on_success
    - when: manual

approval:
  stage: approval
  when: manual
  allow_failure: false
  rules:
    - *deploy_rules
  script:
    - echo "Manual approval required before production deploy"

deploy_production:
  stage: deploy_production
  environment:
    name: production
    url: https://prod.example.com
  needs: ["approval"]
  rules:
    - *deploy_rules
  script:
    - echo "Zero-downtime production deploy"


sonar_scan:
  stage: scan
  image: sonarsource/sonar-scanner-cli:5.0
  script:
    - sonar-scanner         -Dsonar.projectKey=$SONAR_PROJECT_KEY         -Dsonar.organization=$SONAR_ORG         -Dsonar.host.url=$SONAR_HOST_URL         -Dsonar.login=$SONAR_TOKEN
  rules:
    - if: '$SONAR_HOST_URL && $SONAR_TOKEN && $SONAR_PROJECT_KEY'
  needs: [""]
